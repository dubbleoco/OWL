<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OWL — Thought Capture</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Newsreader:ital,opsz,wght@0,6..72,300;0,6..72,400;0,6..72,600;1,6..72,300;1,6..72,400&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0c;
    --surface: #111114;
    --surface-2: #18181c;
    --border: rgba(255,255,255,0.06);
    --text: #e8e6e3;
    --text-dim: rgba(255,255,255,0.35);
    --text-muted: rgba(255,255,255,0.18);
    --idea: #e2a832;
    --idea-bg: rgba(226,168,50,0.08);
    --todo: #5b8ade;
    --todo-bg: rgba(91,138,222,0.08);
    --research: #3dba8a;
    --research-bg: rgba(61,186,138,0.08);
    --memory: #a87bdb;
    --memory-bg: rgba(168,123,219,0.08);
    --urgent: #e05252;
    --urgent-bg: rgba(224,82,82,0.08);
    --mono: 'DM Mono', 'JetBrains Mono', monospace;
    --serif: 'Newsreader', Georgia, serif;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--serif);
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
  }
  ::selection { background: rgba(226,168,50,0.3); }
  ::-webkit-scrollbar { width: 3px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 3px; }

  .shell {
    max-width: 900px;
    margin: 0 auto;
    padding: 60px 24px 120px;
  }

  /* Header */
  .header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    margin-bottom: 48px;
    border-bottom: 1px solid var(--border);
    padding-bottom: 24px;
  }
  .header-left { display: flex; align-items: baseline; gap: 16px; }
  .owl-icon {
    font-size: 28px;
    filter: grayscale(0.3);
  }
  .title {
    font-family: var(--mono);
    font-size: 13px;
    font-weight: 400;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--text-dim);
  }
  .status {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text-muted);
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .status-dot {
    width: 5px; height: 5px;
    border-radius: 50%;
    background: #3dba8a;
    animation: pulse 3s ease-in-out infinite;
  }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

  /* Stats bar */
  .stats {
    display: flex;
    gap: 32px;
    margin-bottom: 40px;
    padding: 16px 0;
  }
  .stat {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .stat-value {
    font-family: var(--mono);
    font-size: 24px;
    font-weight: 300;
    letter-spacing: -0.02em;
    color: var(--text);
  }
  .stat-label {
    font-family: var(--mono);
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-muted);
  }

  /* Filters */
  .filters {
    display: flex;
    gap: 8px;
    margin-bottom: 32px;
    flex-wrap: wrap;
  }
  .filter-btn {
    font-family: var(--mono);
    font-size: 11px;
    letter-spacing: 0.05em;
    padding: 6px 14px;
    border: 1px solid var(--border);
    border-radius: 3px;
    background: transparent;
    color: var(--text-dim);
    cursor: pointer;
    transition: all 0.2s;
  }
  .filter-btn:hover { border-color: rgba(255,255,255,0.15); color: var(--text); }
  .filter-btn.active {
    background: rgba(255,255,255,0.05);
    border-color: rgba(255,255,255,0.2);
    color: var(--text);
  }

  /* Pellet list */
  .pellet-list { display: flex; flex-direction: column; gap: 2px; }

  .pellet {
    display: grid;
    grid-template-columns: 80px 1fr auto;
    gap: 16px;
    align-items: baseline;
    padding: 14px 0;
    border-bottom: 1px solid var(--border);
    animation: fadeIn 0.3s ease;
  }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

  .pellet-type {
    font-family: var(--mono);
    font-size: 10px;
    font-weight: 500;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    padding: 3px 8px;
    border-radius: 2px;
    text-align: center;
    white-space: nowrap;
  }
  .pellet-type.IDEA { color: var(--idea); background: var(--idea-bg); }
  .pellet-type.TODO { color: var(--todo); background: var(--todo-bg); }
  .pellet-type.RESEARCH { color: var(--research); background: var(--research-bg); }
  .pellet-type.MEMORY { color: var(--memory); background: var(--memory-bg); }
  .pellet-type.URGENT { color: var(--urgent); background: var(--urgent-bg); }

  .pellet-content {
    font-family: var(--serif);
    font-size: 15px;
    line-height: 1.55;
    color: var(--text);
  }

  .pellet-meta {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--text-muted);
    white-space: nowrap;
    text-align: right;
  }

  /* Empty state */
  .empty {
    text-align: center;
    padding: 80px 20px;
    color: var(--text-dim);
  }
  .empty-owl { font-size: 48px; margin-bottom: 16px; filter: grayscale(0.5); }
  .empty-text {
    font-family: var(--mono);
    font-size: 12px;
    letter-spacing: 0.05em;
  }

  /* How it works */
  .how-section {
    margin-top: 64px;
    padding-top: 32px;
    border-top: 1px solid var(--border);
  }
  .how-title {
    font-family: var(--mono);
    font-size: 10px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 24px;
  }
  .how-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 24px;
  }
  .how-step-num {
    font-family: var(--mono);
    font-size: 32px;
    font-weight: 300;
    color: rgba(255,255,255,0.04);
    margin-bottom: 6px;
  }
  .how-step-title {
    font-family: var(--mono);
    font-size: 11px;
    font-weight: 500;
    color: var(--text-dim);
    margin-bottom: 6px;
  }
  .how-step-desc {
    font-size: 12px;
    color: var(--text-muted);
    line-height: 1.6;
  }

  /* Loading */
  .loading {
    text-align: center;
    padding: 60px;
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text-muted);
    letter-spacing: 0.1em;
  }

  @media (max-width: 600px) {
    .shell { padding: 32px 16px 80px; }
    .header { flex-direction: column; gap: 12px; }
    .stats { gap: 20px; flex-wrap: wrap; }
    .pellet {
      grid-template-columns: 1fr;
      gap: 6px;
    }
    .pellet-meta { text-align: left; }
    .how-grid { grid-template-columns: 1fr 1fr; }
  }
</style>
</head>
<body>
<div class="shell" id="app">
  <div class="loading">loading pellets...</div>
</div>

<script>
(function() {
  // Parse pellets.json or fall back to reading embedded data
  const APP = document.getElementById('app');

  // Pellet type metadata
  const TYPES = {
    IDEA:     { icon: '\u{1F4A1}', label: 'Idea' },
    TODO:     { icon: '\u26A1',    label: 'To Do' },
    RESEARCH: { icon: '\u{1F50D}', label: 'Research' },
    MEMORY:   { icon: '\u{1F9E0}', label: 'Memory' },
    URGENT:   { icon: '\u{1F534}', label: 'Urgent' }
  };

  let allPellets = [];
  let activeFilter = 'ALL';

  function formatDate(dateStr) {
    const d = new Date(dateStr + 'T00:00:00');
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    return months[d.getMonth()] + ' ' + d.getDate();
  }

  function render() {
    const filtered = activeFilter === 'ALL'
      ? allPellets
      : allPellets.filter(p => p.type === activeFilter);

    // Count by type
    const counts = {};
    allPellets.forEach(p => { counts[p.type] = (counts[p.type] || 0) + 1; });

    const totalCount = allPellets.length;
    const typeKeys = Object.keys(counts).sort();

    APP.innerHTML = `
      <div class="header">
        <div class="header-left">
          <span class="owl-icon">\u{1F989}</span>
          <span class="title">Owl &mdash; Thought Capture</span>
        </div>
        <div class="status">
          <span class="status-dot"></span>
          listening
        </div>
      </div>

      <div class="stats">
        <div class="stat">
          <div class="stat-value">${totalCount}</div>
          <div class="stat-label">Total Pellets</div>
        </div>
        ${typeKeys.map(t => `
          <div class="stat">
            <div class="stat-value">${counts[t]}</div>
            <div class="stat-label">${t}s</div>
          </div>
        `).join('')}
      </div>

      <div class="filters">
        <button class="filter-btn ${activeFilter === 'ALL' ? 'active' : ''}" data-filter="ALL">All</button>
        ${Object.keys(TYPES).map(t => `
          <button class="filter-btn ${activeFilter === t ? 'active' : ''}" data-filter="${t}">${TYPES[t].icon} ${TYPES[t].label}</button>
        `).join('')}
      </div>

      ${filtered.length === 0 ? `
        <div class="empty">
          <div class="empty-owl">\u{1F989}</div>
          <div class="empty-text">${activeFilter === 'ALL' ? 'No pellets yet. Send a thought to Atlas via iMessage.' : 'No ' + activeFilter.toLowerCase() + ' pellets.'}</div>
        </div>
      ` : `
        <div class="pellet-list">
          ${filtered.map(p => `
            <div class="pellet">
              <span class="pellet-type ${p.type}">${p.type}</span>
              <span class="pellet-content">${escapeHtml(p.content)}</span>
              <span class="pellet-meta">${formatDate(p.date)}${p.time ? ' ' + p.time : ''}</span>
            </div>
          `).join('')}
        </div>
      `}

      <div class="how-section">
        <div class="how-title">How it works</div>
        <div class="how-grid">
          <div>
            <div class="how-step-num">01</div>
            <div class="how-step-title">Speak</div>
            <div class="how-step-desc">Text Atlas via iMessage. Raw thoughts, half-baked ideas, quick reminders.</div>
          </div>
          <div>
            <div class="how-step-num">02</div>
            <div class="how-step-title">Classify</div>
            <div class="how-step-desc">Atlas detects the type &mdash; idea, todo, research, memory, urgent &mdash; and asks to confirm.</div>
          </div>
          <div>
            <div class="how-step-num">03</div>
            <div class="how-step-title">Capture</div>
            <div class="how-step-desc">Confirmed pellets are written to Owl's memory files. Nothing gets lost.</div>
          </div>
          <div>
            <div class="how-step-num">04</div>
            <div class="how-step-title">Surface</div>
            <div class="how-step-desc">This dashboard shows everything. Owl remembers so you don't have to.</div>
          </div>
        </div>
      </div>
    `;

    // Attach filter handlers
    APP.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        activeFilter = btn.dataset.filter;
        render();
      });
    });
  }

  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  // Parse markdown memory files format:
  // ## TYPE HH:MM
  // content line(s)
  function parseMemoryMarkdown(dateStr, markdown) {
    const pellets = [];
    const lines = markdown.split('\n');
    let current = null;

    for (const line of lines) {
      const match = line.match(/^## (\w+)\s+(\d{1,2}:\d{2})\s*$/);
      if (match) {
        if (current && current.content.trim()) {
          pellets.push(current);
        }
        current = {
          type: match[1].toUpperCase(),
          time: match[2],
          date: dateStr,
          content: ''
        };
      } else if (current) {
        current.content += (current.content ? '\n' : '') + line;
      }
    }
    if (current && current.content.trim()) {
      pellets.push(current);
    }
    return pellets;
  }

  // Try loading pellets.json first, fall back to empty
  async function loadPellets() {
    try {
      const resp = await fetch('./pellets.json?t=' + Date.now());
      if (resp.ok) {
        const data = await resp.json();
        // data can be raw pellets array or { files: { "2026-02-28": "markdown..." } }
        if (Array.isArray(data)) {
          allPellets = data;
        } else if (data.files) {
          allPellets = [];
          for (const [dateStr, markdown] of Object.entries(data.files)) {
            allPellets.push(...parseMemoryMarkdown(dateStr, markdown));
          }
        }
        // Sort newest first
        allPellets.sort((a, b) => {
          const da = a.date + (a.time || '');
          const db = b.date + (b.time || '');
          return db.localeCompare(da);
        });
      }
    } catch(e) {
      // No pellets.json found — that's fine
      console.log('No pellets.json found, showing empty state');
    }
    render();
  }

  loadPellets();
})();
</script>
</body>
</html>
